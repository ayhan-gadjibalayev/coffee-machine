name: ‚òï Deploy Coffee Machine App

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:  # –î–ª—è —Ä—É—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
    
    - name: ‚éî Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: üì¶ Install dependencies
      run: npm ci
    
    - name: üß™ Run tests (if any)
      run: npm test -- --passWithNoTests
    
    - name: üèó Build project
      run: npm run build
      env:
        CI: false  # –î–ª—è React –ø—Ä–æ–µ–∫—Ç–æ–≤

  deploy-to-wsl:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
    
    - name: üîë Setup SSH access
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.WSL_SSH_KEY }}
    
    - name: üöÄ Deploy to WSL Server
      run: |
        # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –ø–∞–ø–∫—É –¥–ª—è —Å–±–æ—Ä–∫–∏
        mkdir -p dist-build
        cp -r ./* dist-build/ 2>/dev/null || true
        
        # –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ WSL –∏ –¥–µ–ø–ª–æ–∏–º
        ssh -o StrictHostKeyChecking=no yhan@172.17.233.234 "
          echo '=== ‚òï DEPLOYING COFFEE MACHINE APP ==='
          echo 'Deploy time: \$(date)'
          
          # –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É –¥–ª—è –∫–æ—Ñ–µ–π–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
          mkdir -p ~/coffee-machine-app
          cd ~/coffee-machine-app
          
          # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π –ø—Ä–æ—Ü–µ—Å—Å
          echo 'üõë Stopping old process...'
          pkill -f 'coffee-machine' 2>/dev/null || echo 'No old process'
          
          # –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã
          echo 'üßπ Cleaning old files...'
          rm -rf ./*
          
          # –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã —Å–±–æ—Ä–∫–∏
          echo 'üì¶ Copying build files...'
          
          # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤–µ—Ä—Å–∏—é –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–±–æ—Ä–∫–µ
          cat > version.json << 'EOF2'
        {
          \"version\": \"1.0.${{ github.run_number }}\",
          \"build\": \"${{ github.run_number }}\",
          \"commit\": \"${{ github.sha }}\",
          \"deployed\": \"\$(date '+%Y-%m-%d %H:%M:%S')\",
          \"branch\": \"${{ github.ref_name }}\"
        }
        EOF2
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º –æ–±—Ä–∞–∑–æ–º
          if [ -f package.json ] && grep -q 'react-scripts' package.json; then
            echo '‚öõÔ∏è Detected React app'
            # –î–ª—è React —Å–æ–∑–¥–∞–µ–º —Å–µ—Ä–≤–µ—Ä –¥–ª—è —Ä–∞–∑–¥–∞—á–∏ —Å—Ç–∞—Ç–∏–∫–∏
            cat > server.js << 'EOF2'
        const express = require('express');
        const path = require('path');
        const app = express();
        const PORT = 3001;  # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ—Ä—Ç 3001 –¥–ª—è –∫–æ—Ñ–µ–π–Ω–æ–π –º–∞—à–∏–Ω—ã
        
        # –†–∞–∑–¥–∞–µ–º —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã
        app.use(express.static(path.join(__dirname, 'build')));
        
        # API endpoint –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –≤–µ—Ä—Å–∏–∏
        app.get('/api/version', (req, res) => {
          res.json(require('./version.json'));
        });
        
        # –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ index.html
        app.get('*', (req, res) => {
          res.sendFile(path.join(__dirname, 'build', 'index.html'));
        });
        
        app.listen(PORT, () => {
          console.log(\`‚òï Coffee Machine app running on port \${PORT}\`);
          console.log(\`üìÖ Deployed: \$(new Date().toLocaleString())\`);
        });
        EOF2
            
            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Express
            npm init -y
            npm install express
            
          else
            echo 'üîß Generic Node.js/TypeScript app'
            # –î–ª—è –¥—Ä—É–≥–∏—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤ –ø—Ä–æ—Å—Ç–æ –∫–æ–ø–∏—Ä—É–µ–º –∏—Å—Ö–æ–¥–Ω–∏–∫–∏
            cat > start.sh << 'EOF2'
        #!/bin/bash
        echo \"Starting Coffee Machine app...\"
        echo \"Port: 3001\"
        echo \"Build: ${{ github.run_number }}\"
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –ø—Ä–æ–µ–∫—Ç–∞
        if [ -f package.json ]; then
          if grep -q '\"start\"' package.json; then
            npm start
          elif [ -f index.js ]; then
            node index.js
          elif [ -f src/index.js ]; then
            node src/index.js
          else
            echo \"No entry point found. Serving static files.\"
            npx serve -p 3001
          fi
        else
          echo \"No package.json. Using simple HTTP server.\"
          npx serve -p 3001
        fi
        EOF2
            
            chmod +x start.sh
          fi
          
          echo '‚úÖ Files prepared'
          
          # –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
          echo 'üöÄ Starting application...'
          if [ -f server.js ]; then
            nohup node server.js > coffee-app.log 2>&1 &
            echo \"üìù Logs: ~/coffee-machine-app/coffee-app.log\"
          elif [ -f start.sh ]; then
            nohup ./start.sh > coffee-app.log 2>&1 &
            echo \"üìù Logs: ~/coffee-machine-app/coffee-app.log\"
          else
            echo \"‚ö†Ô∏è No startup script found\"
          fi
          
          echo \"üåê App URL: http://localhost:3001\"
          echo \"üìä API version: http://localhost:3001/api/version\"
          echo \"=== ‚úÖ DEPLOYMENT COMPLETE ===\"
        "
    
    - name: ‚úÖ Verify deployment
      run: |
        echo "‚òï Coffee Machine deployment initiated!"
        echo ""
        echo "To check if it's working:"
        echo "1. Connect to WSL: ssh yhan@172.17.233.234"
        echo "2. Check logs: tail -f ~/coffee-machine-app/coffee-app.log"
        echo "3. Test app: curl http://localhost:3001"
        echo ""
        echo "Or from Windows PowerShell:"
        echo "wsl curl http://localhost:3001"