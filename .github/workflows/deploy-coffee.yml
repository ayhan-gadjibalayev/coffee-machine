name: Deploy Coffee Machine to Windows

on:
  push:
    branches: [master]          # –ê–≤—Ç–æ–¥–µ–ø–ª–æ–π –ø—Ä–∏ –ø—É—à–µ –≤ master
  workflow_dispatch:             # –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Ä—É—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞

jobs:
  deploy:
    runs-on: windows-latest     # –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –Ω–∞ Windows‚Äërunner‚Äô–µ GitHub Actions

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        # –°–∫–∞—á–∏–≤–∞–µ—Ç –∫–æ–¥ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –≤ —Ä–∞–±–æ—á—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é

      - name: ‚öôÔ∏è Configure WinRM (HTTPS)
        uses: nicjac/create-winrm-listener@v1
        with:
          Username: ${{ secrets.WINRM_USERNAME }}
          Password: ${{ secrets.WINRM_PASSWORD }}
          Port: 5986                  # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø–æ—Ä—Ç WinRM over HTTPS
          HTTPS: true
          AcceptNewSelfSignedCert: true # –¢–æ–ª—å–∫–æ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è! –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ ‚Äî –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã
        # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç WinRM‚Äë—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –¥–ª—è —É–¥–∞–ª—ë–Ω–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è PowerShell

      - name: ‚òï Deploy to Windows via PowerShell
        uses: nicjac/run-powershell-script@v1
        with:
          UserName: ${{ secrets.WINRM_USERNAME }}
          Password: ${{ secrets.WINRM_PASSWORD }}
          Script: |
            # --- –ù–ê–°–¢–†–û–ô–ö–ò ---
            $DEPLOY_DIR = "$env:USERPROFILE\coffee-machine-deploy"
            $PORT = 3000
            $LOG_FILE = "$DEPLOY_DIR\deploy.log"

            # –ù–∞—á–∏–Ω–∞–µ–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
            Start-Transcript -Path $LOG_FILE -Append
            Write-Host "=== üöÄ STARTING DEPLOYMENT ==="
            Write-Host "Commit: ${{ github.sha }}"
            Write-Host "Build: #${{ github.run_number }}"

            # --- –ü–û–î–ì–û–¢–û–í–ö–ê –î–ò–†–ï–ö–¢–û–†–ò–ò ---
            Write-Host "üßπ Cleaning old deployment..."
            Remove-Item -Path "$DEPLOY_DIR\*" -Recurse -Force -ErrorAction SilentlyContinue

            Write-Host "üì¶ Creating deployment directory: $DEPLOY_DIR"
            New-Item -ItemType Directory -Force -Path $DEPLOY_DIR

            # --- –°–û–ó–î–ê–ù–ò–ï –§–ê–ô–õ–û–í ---
            Write-Host "üìù Creating README.md..."
            @'
            # Coffee Machine App
            '@ | Out-File -FilePath "$DEPLOY_DIR\README.md" -Encoding UTF8

            Write-Host "üìù Creating DEPLOY_INFO.txt..."
            @'
            Deployed via GitHub Actions
            Time: $(Get-Date)
            Commit: ${{ github.sha }}
            Build: #${{ github.run_number }}
            '@ | Out-File -FilePath "$DEPLOY_DIR\DEPLOY_INFO.txt" -Encoding UTF8

            Write-Host "üìù Creating index.html..."
            @'
            <!DOCTYPE html>
            <html>
            <head>
              <title>‚òï Coffee Machine - Deployed!</title>
              <style>
                body { font-family: Arial; margin: 40px; }
                .success { background: #4CAF50; color: white; padding: 20px; }
              </style>
            </head>
            <body>
              <h1>‚òï Coffee Machine Application</h1>
              <div class="success">
                <h2>‚úÖ Successfully Deployed!</h2>
                <p>Deployed via GitHub Actions</p>
                <p>Build: #${{ github.run_number }}</p>
                <p>Commit: ${{ github.sha }}</p>
                <p>Time: $(Get-Date)</p>
              </div>
              <p>Server: Windows</p>
              <p>Host: localhost</p>
            </body>
            </html>
            '@ | Out-File -FilePath "$DEPLOY_DIR\index.html" -Encoding UTF8

            # --- –ó–ê–ü–£–°–ö –í–ï–ë‚Äë–°–ï–†–í–ï–†–ê ---
            Write-Host "üöÄ Starting Python HTTP server on port $PORT..."
            try {
              Start-Process -FilePath "python" -ArgumentList "-m","http.server",$PORT,"--directory",$DEPLOY_DIR -NoNewWindow -RedirectStandardOutput "$DEPLOY_DIR\server.log" -RedirectStandardError "$DEPLOY_DIR\server.error.log"
              Start-Sleep -Seconds 3

              # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞
              if (Test-Path "$DEPLOY_DIR\server.log") {
                Write-Host "‚úÖ Server started on port $PORT"
                Write-Host "üîó App URL: http://localhost:$PORT"
              } else {
                Write-Host "‚ùå Server failed to start"
                if (Test-Path "$DEPLOY_DIR\server.error.log") {
                  Get-Content "$DEPLOY_DIR\server.error.log" | Write-Host
                }
              }
            } catch {
              Write-Host "‚ùå Error starting server: $($_.Exception.Message)"
              exit 1
            }

            # --- –ó–ê–í–ï–†–®–ï–ù–ò–ï ---
            Write-Host "=== ‚úÖ DEPLOYMENT COMPLETE ==="
            Stop-Transcript
          # ComputerName: <IP_ADDRESS>  # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: —É–∫–∞–∂–∏—Ç–µ IP —Å–µ—Ä–≤–µ—Ä–∞, –µ—Å–ª–∏ –Ω–µ localhost

      - name: ‚úÖ Verify deployment
        run: |
          echo ""
          echo "‚úÖ DEPLOYMENT COMPLETED!"
          echo "========================"
          echo "üåê Access your app: http://localhost:3000"
          echo ""
          echo "üìÅ Files deployed to: $env:USERPROFILE\coffee-machine-deploy"
          echo "üìã Logs: $env:USERPROFILE\coffee-machine-deploy\deploy.log"
          echo ""
        # –í—ã–≤–æ–¥–∏—Ç –∏—Ç–æ–≥–æ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –ª–æ–≥ GitHub Actions
